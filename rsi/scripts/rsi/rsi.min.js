/** Remote Script Injection Based On Time (AKA rsi-bot).
* An innovative alternative to AJAX. 
* (c) Danny Shraga 2010. All rights reserved.
* @author Danny Shraga 
* @date 30/04/2010 05:58 
* @version 1.0 
**/

if(!this.Utils){this.Utils={};}
(function(){if(typeof Utils.isArray!=='function'){Utils.isArray=function(_obj){if(_obj.constructor.toString().indexOf("Array")==-1){return false;}
return true;};}
if(typeof Utils.isEmpty!=='function'){Utils.isEmpty=function(_obj){var empty=false;if(_obj==null||_obj=="undefined"||_obj==""){return true;}
if(Utils.isArray(_obj)){for(var i=0;i<_obj.length;i++){empty=Utils.isEmpty(_obj[i]);if(!empty){break;}}
if(empty){return true;}
return false;}
if(_obj.length){for(var i=0;i<_obj.length;i++){if(_obj[i]!=" "){empty=false;break;}}}
if(empty){return true;}
return false;};}
if(typeof Utils.getDuration!=='function'){Utils.getDuration=function(_startTime,_endTime){var _duration=0;if(Utils.isEmpty(_startTime)){return 0;}
if(Utils.isEmpty(_endTime)){_endTime=new Date().getTime();}
return _endTime-_startTime;};}
if(typeof Utils.Map!=='function'){Utils.Map=function(){if(this.arrKeys==null){this.arrKeys=new Array();}
if(this.arrValues==null){this.arrValues=new Array();};this.indexOf=function(_key){var _currKey=null;var _index=-1;if(Utils.isEmpty(_key)||this.arrKeys==null||!Utils.isArray(this.arrKeys)){return _index;}
for(var i=0;i<this.arrKeys.length;i++){_currKey=this.arrKeys[i];if(_currKey.toLowerCase()==_key.toLowerCase()){_index=i;break;}}
return _index;};this.get=function(_key){var _retVal=null;var _index=-1;if(Utils.isEmpty(_key)||this.arrKeys==null||!Utils.isArray(this.arrKeys)||this.arrValues==null||!Utils.isArray(this.arrValues)){return _retVal;}
_index=this.indexOf(_key);if(_index>-1&&_index<this.arrValues.length){_retVal=this.arrValues[_index];}
return _retVal;};this.contains=function(_key){var _index=this.indexOf(_key);return(_index==-1?false:true);};this.put=function(_key,_value){var _index=-1;if(Utils.isEmpty(_key)){return;}
_index=this.indexOf(_key);if(_index==-1){this.arrKeys.push(_key);this.arrValues.push(_value);}
else if(_index<this.arrValues.length){this.arrValues[_index]=_value;}};this.size=function(){return this.arrKeys.length;};this.getLastKey=function(){var _length=this.arrKeys.length;if(_length==0){return null;}
return this.arrKeys.slice(_length-1)[0];};this.getLastValue=function(){var _length=this.arrValues.length;if(_length==0){return null;}
return this.arrValues.slice(_length-1)[0];};this.remove=function(_key){var _index=this.indexOf(_key);var _value=null;if(_index==-1){return;}
_value=this.arrValues[_index];this.arrKeys.splice(_index,1);this.arrValues.splice(_index,1);return _value;};};}}());if(!this.RSI){this.RSI={};}
(function(){var __scriptMap=new Utils.Map();var __requestTimeout=3000;if(typeof RSI.Request!=='function'){RSI.Request=function(_url,_index){this.url=_url;this.indexId=_index;this.scriptId="_rsiScript"+_index;this.intervalId=null;this.interval=-1;this.onSuccess=null;this.onFailure=null;this.clientStartTime=0;this.clientEndTime=0;this.clientDuration=0;this.serverStartTime=0;this.serverEndTime=0;this.serverDuration=0;this.responseStatus=0;this.responseLength=0;this.response=null;};}
if(typeof RSI.getMap!=='function'){RSI.getMap=function(){return __scriptMap;};}
if(typeof RSI.getDefaultInterval!=='function'){RSI.getDefaultInterval=function(){return 1000;};}
if(typeof RSI.getMinInterval!=='function'){RSI.getMinInterval=function(){return 500;};}
if(typeof RSI.setRequestTimeout!=='function'){RSI.setRequestTimeout=function(requestTimeout){__requestTimeout=requestTimeout;};}
if(typeof RSI.getRequestTimeout!=='function'){RSI.getRequestTimeout=function(){return __requestTimeout;};}
if(typeof RSI.getReuseScript!=='function'){RSI.getReuseScript=function(){return false;};}
if(typeof RSI.getScriptsContainer!=='function'){RSI.getScriptsContainer=function(){var _scriptsContainerId="_rsiScriptsContainer";var _scriptsContainer=null;var _doc=document;_scriptsContainer=_doc.getElementById(_scriptsContainerId);if(_scriptsContainer==null){_scriptsContainer=_doc.createElement("div");_scriptsContainer.id=_scriptsContainerId;_scriptsContainer.setAttribute("style","display:none;");_doc.body.appendChild(_scriptsContainer);}
return _scriptsContainer;};}
if(typeof RSI.add!=='function'){RSI.add=function(_request){RSI.__getScriptTag(_request);};}
if(typeof RSI.createRequest!=='function'){RSI.createRequest=function(_url){var rsiRequest=null;var request=null;if(Utils.isEmpty(_url)){return null;}
rsiRequest=RSI.getMap().get(_url);if(rsiRequest==null){return null;}
request={url:_url,onsuccess:rsiRequest.onSuccess,onfailure:rsiRequest.onFailure};return request;};}
if(typeof RSI.remove!=='function'){RSI.remove=function(_url){RSI.stopThread(_url);RSI.__removeScriptTag(_url);return RSI.getMap().remove(_url);};}
if(typeof RSI.__removeScriptTag!=='function'){RSI.__removeScriptTag=function(_url){var scriptsContainer=null;var scriptTag=null;var rsiRequest=RSI.getMap().get(_url);if(rsiRequest==null){return;}
scriptsContainer=RSI.getScriptsContainer();if(scriptsContainer==null){return;}
scriptTag=document.getElementById(rsiRequest.scriptId);if(scriptTag==null){return;}
scriptsContainer.removeChild(scriptTag);};}
if(typeof RSI.__getScriptTag!=='function'){RSI.__getScriptTag=function(_request){var _url=null;var _onSuccess=null;var _onFailure=null;var _rsiRequest=null;var _scriptsContainer=null;var _scriptTag=null;var _currIndex=0;var _doc=null;var _map=RSI.getMap();var _createNewScript=false;var _lastRsiRequest=null;if(Utils.isEmpty(_request)){return null;}
_url=RSI.__getUrlFromRequest(_request);if(Utils.isEmpty(_url)){return null;}
if(_request.onsuccess){_onSuccess=_request.onsuccess;}
if(_request.onfailure){_onFailure=_request.onfailure;}
_doc=document;_rsiRequest=_map.get(_url);if(_rsiRequest==null){_lastRsiRequest=_map.getLastValue();if(_lastRsiRequest==null){_currIndex=1;}
else{_currIndex=_lastRsiRequest.indexId+1;}
_rsiRequest=new RSI.Request(_url,_currIndex);}
_scriptsContainer=RSI.getScriptsContainer();_scriptTag=_doc.getElementById(_rsiRequest.scriptId);if(_scriptTag==null){_createNewScript=true;}
else{if(RSI.getReuseScript()){_createNewScript=false;}
else{RSI.__removeScriptTag(_url);_createNewScript=true;}}
if(_createNewScript){_scriptTag=_doc.createElement("script");_scriptTag.id=_rsiRequest.scriptId;_scriptTag.setAttribute("type","text/javascript");_scriptsContainer.appendChild(_scriptTag);}
_rsiRequest.onSuccess=_onSuccess;_rsiRequest.onFailure=_onFailure;_map.put(_url,_rsiRequest);return _scriptTag;};}
if(typeof RSI.__getUrlFromRequest!=='function'){RSI.__getUrlFromRequest=function(_request){var _url=null;var _paramsStr="";if(Utils.isEmpty(_request)){return null;}
if(_request.url){_url=_request.url;}
if(Utils.isEmpty(_url)){return null;}
_paramsStr=RSI.__getParamsFromRequest(_request);if(!Utils.isEmpty(_paramsStr)){if(_url.indexOf("?")==-1){_url+="?";}
else if(_url[_url.length-1]!="&"){_url+="&";}
_url+=_paramsStr;}
return _url;};}
if(typeof RSI.__getParamsFromRequest!=='function'){RSI.__getParamsFromRequest=function(_request){var _params=null;var _paramKeyValueDelimiter=":";var _indexKeyValueDelimiter=-1;var _currParam=null;var _currParamKey=null;var _currParamValue=null;var _paramsStr="";if(Utils.isEmpty(_request)){return null;}
if(_request.params){_params=_request.params;}
if(!Utils.isEmpty(_params)){if(!Utils.isArray(_params)){_params=new Array(_params);}
for(var i=0;i<_params.length;i++){_currParam=_params[i];_indexKeyValueDelimiter=_currParam.indexOf(_paramKeyValueDelimiter);if(_indexKeyValueDelimiter>-1){_currParamKey=_currParam.substr(0,_indexKeyValueDelimiter);_currParamValue=_currParam.substr(_indexKeyValueDelimiter);;_paramsStr+="&"+_currParamKey+"="+_currParamValue;}}
if(!Utils.isEmpty(_paramsStr)){_paramsStr=_paramsStr.substr(1);}}
return _paramsStr;};}
if(typeof RSI.doGet!=='function'){RSI.doGet=function(_url){var _key=null;var _rsiRequest=null;var _request=null;var _scriptTag=null;var _time=null;if(Utils.isEmpty(_url)){return;}
_key=_url;_rsiRequest=RSI.getMap().get(_key);if(_rsiRequest==null){return;}
_request=RSI.createRequest(_url);_scriptTag=RSI.__getScriptTag(_request);if(_scriptTag==null){return;}
if(_url.indexOf("?")==-1){_url+="?";}
else if(_url[_url.length-1]!="&"){_url+="&";}
_url+=RSI.__getCallBack();_time=new Date().getTime();_url+="&time="+_time;_rsiRequest.clientStartTime=_time;_rsiRequest.responseStatus=0;_rsiRequest.responseLength=0;_rsiRequest.response=null;RSI.getMap().put(_key,_rsiRequest);try{_scriptTag.setAttribute("src",_url);}
catch(error){}};}
if(typeof RSI.threadIsAlive!=='function'){RSI.threadIsAlive=function(_url){var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return false;}
if(_rsiRequest.intervalId==null){return false;}
return true;};}
if(typeof RSI.requestTimedout!=='function'){RSI.requestTimedout=function(_url){var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return true;}
if(_rsiRequest.responseStatus==0){var currTime=new Date().getTime();if((currTime-_rsiRequest.clientStartTime)>RSI.getRequestTimeout()){return true;}}
return false;};}
if(typeof RSI.sleep!=='function'){RSI.sleep=function(_duration,_callback){var fixedCallback=_callback.replace(/"\""/g,"\\\"");window.setTimeout("RSI.__void('"+fixedCallback+"')",_duration);};}
if(typeof RSI.__void!=='function'){RSI.__void=function(_callback){eval(_callback);};}
if(typeof RSI.__getCallBack!=='function'){RSI.__getCallBack=function(){return"onsuccess=RSI.__onSuccess&onfailure=RSI.__onFailure";};}
if(typeof RSI.__getContentLength!=='function'){RSI.__getContentLength=function(_requestUrl,_response){var _funcName="RSI.__onFailure";var retVal=_funcName+"('"+_requestUrl+"','"+_response+"')";return retVal.length;};}
if(typeof RSI.__onSuccess!=='function'){RSI.__onSuccess=function(_requestUrl,_response){var _strCallback=RSI.__getCallBack();var _url=_requestUrl.replace(_strCallback,"");var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return;}
_rsiRequest.clientEndTime=new Date().getTime();_rsiRequest.clientDuration=Utils.getDuration(_rsiRequest.clientStartTime,_rsiRequest.clientEndTime);_rsiRequest.responseStatus=200;_rsiRequest.responseLength=RSI.__getContentLength(_requestUrl,_response);_rsiRequest.response=_response;RSI.getMap().put(_url,_rsiRequest);var _callback=_rsiRequest.onSuccess;if(!Utils.isEmpty(_callback)){if(typeof _callback!=='function'){eval(_callback+"('"+_requestUrl+"','"+_response+"')");}
else{_callback(_requestUrl,_response);}}};}
if(typeof RSI.__onFailure!=='function'){RSI.__onFailure=function(_requestUrl,_response){var _strCallback=RSI.__getCallBack();var _url=_requestUrl.replace(_strCallback,"");var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return;}
_rsiRequest.clientEndTime=new Date().getTime();_rsiRequest.clientDuration=Utils.getDuration(_rsiRequest.clientStartTime,_rsiRequest.clientEndTime);_rsiRequest.responseStatus=200;_rsiRequest.responseLength=RSI.__getContentLength(_requestUrl,_response);_rsiRequest.response=_response;RSI.getMap().put(_url,_rsiRequest);var _callback=_rsiRequest.onFailure;if(!Utils.isEmpty(_callback)){if(typeof _callback!=='function'){eval(_callback+"('"+_requestUrl+"','"+_response+"')");}
else{_callback(_requestUrl,_response);}}};}
if(typeof RSI.startThread!=='function'){RSI.startThread=function(threadConfig){var _request=null;var _interval=null;var _doBeforeInterval=null;var _url=null;var _rsiRequest=null;var _intervalId=null;var _map=RSI.getMap();var _time=null;var _threadAction=null;if(Utils.isEmpty(threadConfig)){return;}
if(threadConfig.request){_request=threadConfig.request;}
if(threadConfig.interval){_interval=threadConfig.interval;}
if(threadConfig.threadAction){_threadAction=threadConfig.threadAction;}
if(threadConfig.doBeforeInterval){_doBeforeInterval=threadConfig.doBeforeInterval;}
if(_request==null){return;}
_url=RSI.__getUrlFromRequest(_request);if(Utils.isEmpty(_url)){return;}
if(Utils.isEmpty(_interval)){_interval=RSI.getDefaultInterval();}
if(Utils.isEmpty(_threadAction)){_threadAction="RSI.doGet('"+_url+"')";}
if(Utils.isEmpty(_doBeforeInterval)){_doBeforeInterval=false;}
if(isNaN(_interval)){alert("RSI.startThread(): _interval ["+_interval+"] is not a number...");return;}
else if(_interval<RSI.getMinInterval()){alert("RSI.startThread(): _interval ["+_interval+"] must be bigger than "+RSI.getMinInterval()+"...");return;}
_rsiRequest=_map.get(_url);if(_rsiRequest==null){RSI.add(_request);_rsiRequest=_map.get(_url);if(_rsiRequest==null){return;}}
if(_rsiRequest.intervalId==null){if(_doBeforeInterval){RSI.doGet(_url);}
_rsiRequest.interval=_interval;_intervalId=window.setInterval(_threadAction,_rsiRequest.interval);_rsiRequest.intervalId=_intervalId;_time=new Date().getTime();_rsiRequest.clientStartTime=_time;_map.put(_url,_rsiRequest);}};}
if(typeof RSI.stopThread!=='function'){RSI.stopThread=function(_url){var _rsiRequest=null;var _map=RSI.getMap();if(Utils.isEmpty(_url)){return;}
_rsiRequest=_map.get(_url);if(_rsiRequest==null){return;}
if(_rsiRequest.intervalId!=null){try{window.clearInterval(_rsiRequest.intervalId);}
catch(error){}
_rsiRequest.clientEndTime=new Date().getTime();_rsiRequest.clientDuration=Utils.getDuration(_rsiRequest.clientStartTime,_rsiRequest.clientEndTime);_rsiRequest.intervalId=null;_map.put(_url,_rsiRequest);}};}}());function formatDateTime(dateObj,format){var day,month,year,hours,minutes,seconds,milliseconds=0;var dateDelimiter="/";var dateTimeDelimiter=" ";var timeDelimiter=":";var retVal="";var minValue=10;var formatDay="d";var formatDays="dd";var formatMonth="M";var formatMonths="MM";var formatYear="yyyy";var formatHour="H";var formatHours="HH";var formatMinute="m";var formatMinutes="mm";var formatSecond="S";var formatSeconds="SS";var formatMilliseconds="sss";if(dateObj==null||dateObj=='undefined'){return null;}
if(format==null||format=='undefined'){format="dd/MM/yyyy HH:mm:SS:sss";}
day=dateObj.getDate();if(day<minValue){if(format.toLowerCase().indexOf(formatDays)>-1){day="0"+day;}}
month=dateObj.getMonth()+1;if(month<minValue){if(format.indexOf(formatMonths)>-1){month="0"+month;}}
year=dateObj.getFullYear();hours=dateObj.getHours();if(hours<minValue){if(format.toLowerCase().indexOf(formatHours.toLowerCase())>-1){hours="0"+hours;}}
minutes=dateObj.getMinutes();if(minutes<minValue){if(format.toLowerCase().indexOf(formatMinutes)>-1){minutes="0"+minutes;}}
seconds=dateObj.getSeconds();if(seconds<minValue){if(format.indexOf(formatSeconds)>-1){seconds="0"+seconds;}}
milliseconds=dateObj.getMilliseconds();if((format.toLowerCase().indexOf(formatDays)>-1)||(format.toLowerCase().indexOf(formatDay)>-1)){retVal+=day;}
if((format.indexOf(formatMonths)>-1)||(format.indexOf(formatMonth)>-1)){retVal+=dateDelimiter+month;}
if(format.toLowerCase().indexOf(formatYear)>-1){retVal+=dateDelimiter+year;}
if((format.toLowerCase().indexOf(formatHours.toLowerCase())>-1)||(format.toLowerCase().indexOf(formatHour.toLowerCase())>-1)){retVal+=dateTimeDelimiter+hours;}
if((format.toLowerCase().indexOf(formatMinutes)>-1)||(format.toLowerCase().indexOf(formatMinute)>-1)){retVal+=timeDelimiter+minutes;}
if((format.indexOf(formatSeconds)>-1)||(format.indexOf(formatSecond)>-1)){retVal+=timeDelimiter+seconds;}
if(format.toLowerCase().indexOf(formatMilliseconds)>-1){retVal+=timeDelimiter+milliseconds;}
return retVal;}
