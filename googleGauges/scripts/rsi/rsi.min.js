/** Remote Script Injection Based On Time (AKA rsi-bot).
* An innovative alternative to AJAX. 
* (c) Danny Shraga 2010. All rights reserved.
* @author Danny Shraga 
* @date 30/04/2010 05:58 
* @version 1.0 
**/


if(!this.Utils){this.Utils={};}
(function(){if(typeof Utils.isArray!=='function'){Utils.isArray=function(_obj){if(_obj.constructor.toString().indexOf("Array")==-1){return false;}
return true;};}
if(typeof Utils.isEmpty!=='function'){Utils.isEmpty=function(_obj){if(_obj==null||_obj=="undefined"||_obj==""){return true;}
return false;};}
if(typeof Utils.getDuration!=='function'){Utils.getDuration=function(_startTime,_endTime){var _duration=0;if(Utils.isEmpty(_startTime)){return 0;}
if(Utils.isEmpty(_endTime)){_endTime=new Date().getTime();}
return _endTime-_startTime;};}
if(typeof Utils.Map!=='function'){Utils.Map=function(){if(this.arrKeys==null){this.arrKeys=new Array();}
if(this.arrValues==null){this.arrValues=new Array();};this.indexOf=function(_key){var _currKey=null;var _index=-1;if(Utils.isEmpty(_key)||this.arrKeys==null||!Utils.isArray(this.arrKeys)){return _index;}
for(var i=0;i<this.arrKeys.length;i++){_currKey=this.arrKeys[i];if(_currKey.toLowerCase()==_key.toLowerCase()){_index=i;break;}}
return _index;};this.get=function(_key){var _retVal=null;var _index=-1;if(Utils.isEmpty(_key)||this.arrKeys==null||!Utils.isArray(this.arrKeys)||this.arrValues==null||!Utils.isArray(this.arrValues)){return _retVal;}
_index=this.indexOf(_key);if(_index>-1&&_index<this.arrValues.length){_retVal=this.arrValues[_index];}
return _retVal;};this.contains=function(_key){var _index=this.indexOf(_key);return(_index==-1?false:true);};this.put=function(_key,_value){var _index=-1;if(Utils.isEmpty(_key)){return;}
_index=this.indexOf(_key);if(_index==-1){this.arrKeys.push(_key);this.arrValues.push(_value);}
else if(_index<this.arrValues.length){this.arrValues[_index]=_value;}};this.size=function(){return this.arrKeys.length;};this.getLastKey=function(){var _length=this.arrKeys.length;if(_length==0){return null;}
return this.arrKeys.slice(_length-1)[0];};this.getLastValue=function(){var _length=this.arrValues.length;if(_length==0){return null;}
return this.arrValues.slice(_length-1)[0];};this.remove=function(_key){var _index=this.indexOf(_key);var _value=null;if(_index==-1){return;}
_value=this.arrValues[_index];this.arrKeys.splice(_index,1);this.arrValues.splice(_index,1);return _value;};};}}());if(!this.RSI){this.RSI={};}
(function(){var __scriptMap=new Utils.Map();var __minSleep=100;var __reuseScript=false;if(typeof RSI.getMap!=='function'){RSI.getMap=function(){return __scriptMap;};}
if(typeof RSI.getMinSleep!=='function'){RSI.getMinSleep=function(){return __minSleep;};}
if(typeof RSI.setReuseScript!=='function'){RSI.setReuseScript=function(_reuseScript){if(Utils.isEmpty(_request)){_reuseScript=false;}
__reuseScript=_reuseScript;};}
if(typeof RSI.Request!=='function'){RSI.Request=function(_url,_index){this.url=_url;this.indexId=_index;this.scriptHolderId="_rsiScriptDiv"+_index;this.scriptId="_rsiScript"+_index;this.intervalId=null;this.interval=-1;this.hasFailed=false;this.hasSucceded=false;this.onSuccess=null;this.onFailure=null;this.threadAction=null;this.clientStartTime=0;this.clientEndTime=0;this.clientDuration=0;this.serverStartTime=0;this.serverEndTime=0;this.serverDuration=0;};}
if(typeof RSI.create!=='function'){RSI.create=function(_request){RSI.__getScriptTag(_request);};}
if(typeof RSI.remove!=='function'){RSI.remove=function(_url){RSI.stopThread(_url);RSI.__removeScriptTag(_url);return RSI.getMap().remove(_url);};}
if(typeof RSI.__removeScriptTag!=='function'){RSI.__removeScriptTag=function(_url){var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return;}
var scriptHolderObj=document.getElementById(_rsiRequest.scriptHolderId);if(scriptHolderObj==null){return;}
document.body.removeChild(scriptHolderObj);};}
if(typeof RSI.__getScriptTag!=='function'){RSI.__getScriptTag=function(_request){var _url=null;var _onSuccess=null;var _onFailure=null;var _rsiRequest=null;var _scriptTagHolder=null;var _scriptTag=null;var _currIndex=0;var _doc=null;var _map=RSI.getMap();var _createNewScript=false;if(Utils.isEmpty(_request)){return null;}
_url=RSI.__getUrlFromRequest(_request);if(Utils.isEmpty(_url)){return null;}
if(_request.onsuccess){_onSuccess=_request.onsuccess;}
if(_request.onfailure){_onFailure=_request.onfailure;}
_doc=document;_rsiRequest=_map.get(_url);if(_rsiRequest==null){_lastRsiRequest=_map.getLastValue();if(_lastRsiRequest==null){_currIndex=1;}
else{_currIndex=_lastRsiRequest.indexId+1;}
_rsiRequest=new RSI.Request(_url,_currIndex);}
_scriptTag=_doc.getElementById(_rsiRequest.scriptId);if(_scriptTag==null){_createNewScript=true;}
else{if(__reuseScript){_createNewScript=false;}
else{RSI.__removeScriptTag(_url);_createNewScript=true;}}
if(_createNewScript){_scriptTagHolder=_doc.createElement("div");_scriptTagHolder.id=_rsiRequest.scriptHolderId;_scriptTagHolder.setAttribute("style","display:none;");_scriptTag=_doc.createElement("script");_scriptTag.id=_rsiRequest.scriptId;_scriptTag.setAttribute("type","text/javascript");_scriptTagHolder.appendChild(_scriptTag);_doc.body.appendChild(_scriptTagHolder);}
_rsiRequest.onSuccess=_onSuccess;_rsiRequest.onFailure=_onFailure;_map.put(_url,_rsiRequest);return _scriptTag;};}
if(typeof RSI.__getUrlFromRequest!=='function'){RSI.__getUrlFromRequest=function(_request){var _url=null;var _paramsStr="";if(Utils.isEmpty(_request)){return null;}
if(_request.url){_url=_request.url;}
if(Utils.isEmpty(_url)){return null;}
_paramsStr=RSI.__getParamsFromRequest(_request);if(!Utils.isEmpty(_paramsStr)){if(_url.indexOf("?")==-1){_url+="?";}
_url+=_paramsStr;}
return _url;};}
if(typeof RSI.__getParamsFromRequest!=='function'){RSI.__getParamsFromRequest=function(_request){var _params=null;var _paramKeyValueDelimiter=":";var _indexKeyValueDelimiter=-1;var _currParam=null;var _currParamKey=null;var _currParamValue=null;var _paramsStr="";if(Utils.isEmpty(_request)){return null;}
if(_request.params){_params=_request.params;}
if(!Utils.isEmpty(_params)){if(!Utils.isArray(_params)){_params=new Array(_params);}
for(var i=0;i<_params.length;i++){_currParam=_params[i];_indexKeyValueDelimiter=_currParam.indexOf(_paramKeyValueDelimiter);if(_indexKeyValueDelimiter>-1){_currParamKey=_currParam.substr(0,_indexKeyValueDelimiter);_currParamValue=_currParam.substr(_indexKeyValueDelimiter);;_paramsStr+=_currParamKey+"="+_currParamValue+"&";}}}
return _paramsStr;};}
if(typeof RSI.doGet!=='function'){RSI.doGet=function(_request){var _url=null;var _key=null;var _rsiRequest=null;var _paramsStr="";var _scriptTag=null;var _time=new Date().getTime();_url=RSI.__getUrlFromRequest(_request);if(Utils.isEmpty(_url)){return;}
_scriptTag=RSI.__getScriptTag(_request);if(_scriptTag==null){return;}
_key=_url;_rsiRequest=RSI.getMap().get(_key);if(_rsiRequest==null){return;}
_paramsStr=RSI.__getParamsFromRequest(_request);if(_url.indexOf("?")==-1){_url+="?";}
else{if(Utils.isEmpty(_paramsStr)){_url+="&";}}
_url+=RSI.__getCallBack();_url+="&time="+_time;_rsiRequest.hasSucceded=false;_rsiRequest.hasFailed=false;_rsiRequest.clientStartTime=_time;RSI.getMap().put(_key,_rsiRequest);try{_scriptTag.setAttribute("src",_url);}
catch(error){}};}
if(typeof RSI.isAlive!=='function'){RSI.isAlive=function(_url){var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return false;}
if(_rsiRequest.hasSucceded||_rsiRequest.hasFailed){return true;}
return false;};}
if(typeof RSI.sleep!=='function'){RSI.sleep=function(_duration,_callback){var fixedCallback=_callback.replace(/"\""/g,"\\\"");window.setTimeout("RSI.__void('"+fixedCallback+"')",_duration);};}
if(typeof RSI.__void!=='function'){RSI.__void=function(_callback){eval(_callback);};}
if(typeof RSI.__getCallBack!=='function'){RSI.__getCallBack=function(){return"onsuccess=RSI.__onSuccess&onfailure=RSI.__onFailure";};}
if(typeof RSI.__onSuccess!=='function'){RSI.__onSuccess=function(_requestUrl,_response){var _strCallback=RSI.__getCallBack();var _url=_requestUrl.replace(_strCallback,"");var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return;}
_rsiRequest.hasSucceded=true;_rsiRequest.hasFailed=false;_rsiRequest.clientEndTime=new Date().getTime();_rsiRequest.clientDuration=Utils.getDuration(_rsiRequest.clientStartTime,_rsiRequest.clientEndTime);RSI.getMap().put(_url,_rsiRequest);var _callback=_rsiRequest.onSuccess;if(!Utils.isEmpty(_callback)){eval(_callback+"('"+_requestUrl+"','"+_response+"')");}};}
if(typeof RSI.__onFailure!=='function'){RSI.__onFailure=function(_requestUrl,_response){var _strCallback=RSI.__getCallBack();var _url=_requestUrl.replace(_strCallback,"");var _rsiRequest=RSI.getMap().get(_url);if(_rsiRequest==null){return;}
RSI.stopThread(_url);_rsiRequest.hasFailed=true;_rsiRequest.hasSucceded=false;_rsiRequest.clientEndTime=new Date().getTime();_rsiRequest.clientDuration=Utils.getDuration(_rsiRequest.clientStartTime,_rsiRequest.clientEndTime);RSI.getMap().put(_url,_rsiRequest);var _callback=_rsiRequest.onFailure;if(!Utils.isEmpty(_callback)){eval(_callback+"('"+_requestUrl+"','"+_response+"')");}};}
if(typeof RSI.startThread!=='function'){RSI.startThread=function(_request,_threadAction,_sleep,_doBeforeSleep){var _url=null;var _paramsStr="";var _rsiRequest=null;var _intervalId=null;var _map=RSI.getMap();var _time=new Date().getTime();if(Utils.isEmpty(_request)||Utils.isEmpty(_threadAction)||Utils.isEmpty(_sleep)){return;}
if(Utils.isEmpty(_sleep)){_sleep=1000;}
if(isNaN(_sleep)){alert("RSI.startThread(): _sleep ["+_sleep+"] is not a number...");return;}
else if(_sleep<RSI.getMinSleep()){alert("RSI.startThread(): _sleep ["+_sleep+"] must be bigger than "+RSI.getMinSleep()+"...");return;}
_url=RSI.__getUrlFromRequest(_request);if(Utils.isEmpty(_url)){return;}
_rsiRequest=_map.get(_url);if(_rsiRequest==null){RSI.create(_request);_rsiRequest=_map.get(_url);if(_rsiRequest==null){return;}}
if(_rsiRequest.intervalId==null){if(Utils.isEmpty(_doBeforeSleep)){_doBeforeSleep=false;}
if(_doBeforeSleep){RSI.doGet(_request);}
_rsiRequest.interval=_sleep;_rsiRequest.threadAction=_threadAction;_intervalId=window.setInterval(_threadAction,_rsiRequest.interval);_rsiRequest.intervalId=_intervalId;_rsiRequest.clientStartTime=_time;_map.put(_url,_rsiRequest);}};}
if(typeof RSI.stopThread!=='function'){RSI.stopThread=function(_url){var _rsiRequest=null;var _map=RSI.getMap();if(Utils.isEmpty(_url)){return;}
_rsiRequest=_map.get(_url);if(_rsiRequest==null){return;}
if(_rsiRequest.intervalId!=null){try{window.clearInterval(_rsiRequest.intervalId);}
catch(error){}
_rsiRequest.clientEndTime=new Date().getTime();_rsiRequest.clientDuration=Utils.getDuration(_rsiRequest.clientStartTime,_rsiRequest.clientEndTime);_rsiRequest.intervalId=null;_map.put(_url,_rsiRequest);}};}
if(typeof RSI.setInterval!=='function'){RSI.setInterval=function(_url,_interval){var _rsiRequest=null;var _map=RSI.getMap();if(Utils.isEmpty(_url)||Utils.isEmpty(_interval)){return;}
_rsiRequest=_map.get(_url);if(_rsiRequest==null){return;}
_rsiRequest.interval=_interval;_map.put(_url,_rsiRequest);};}}());function formatDateTime(dateObj){var day,month,year,hours,minutes,seconds,milliseconds=0;var dateDelimiter="/";var dateTimeDelimiter=" ";var timeDelimiter=":";var retVal=null;var minValue=10;if(dateObj==null||dateObj=='undefined'){return null;}
day=dateObj.getDay();if(day<minValue){day="0"+day;}
month=dateObj.getMonth()+1;if(month<minValue){month="0"+month;}
year=dateObj.getFullYear();hours=dateObj.getHours();if(hours<minValue){hours="0"+hours;}
minutes=dateObj.getMinutes();if(minutes<minValue){minutes="0"+minutes;}
seconds=dateObj.getSeconds();if(seconds<minValue){seconds="0"+seconds;}
milliseconds=dateObj.getMilliseconds();retVal=day+dateDelimiter+month+dateDelimiter+year+dateTimeDelimiter+hours+timeDelimiter+minutes+timeDelimiter+seconds+timeDelimiter+milliseconds;return retVal;}
